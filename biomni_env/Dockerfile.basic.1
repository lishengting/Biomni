# Biomni Basic Environment Dockerfile - 优化版
# 快速部署基础AI代理环境，使用国内镜像源

FROM ubuntu:22.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PATH="/opt/biomni_tools/bin:$PATH"
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# 设置工作目录
WORKDIR /opt/biomni

# 配置国内APT镜像源  # 基础镜像根本没有这个文件，所以不需要配置
#RUN sed -i 's@deb.debian.org@mirrors.tuna.tsinghua.edu.cn@g' /etc/apt/sources.list && \
#    sed -i 's@security.debian.org@mirrors.tuna.tsinghua.edu.cn@g' /etc/apt/sources.list

# 安装系统依赖 - 合并为单个RUN命令
RUN apt-get update && apt-get install -y --no-install-recommends \
    # 基础工具
    wget curl git vim nano ca-certificates \
    # Python环境
    python3 python3-pip python3-dev \
    # 编译环境
    build-essential gcc g++ make cmake \
    # 系统依赖
    jq unzip zip bzip2 gzip xz-utils \
    # 科学计算依赖
    libz-dev libbz2-dev liblzma-dev \
    libcurl4-openssl-dev libssl-dev \
    libxml2-dev libpng-dev libjpeg-dev \
    libfreetype6-dev libtiff5-dev \
    libblas-dev liblapack-dev libgsl-dev \
    pkg-config libsentencepiece-dev \
    # 清理缓存
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# 安装Miniconda - 使用官方源
RUN wget -qO /tmp/miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
    bash /tmp/miniconda.sh -b -p /opt/miniconda3 && \
    rm /tmp/miniconda.sh && \
    # 配置官方conda源
    /opt/miniconda3/bin/conda config --add channels https://repo.anaconda.com/pkgs/main && \
    /opt/miniconda3/bin/conda config --add channels https://repo.anaconda.com/pkgs/free && \
    /opt/miniconda3/bin/conda config --add channels https://repo.anaconda.com/pkgs/r && \
    /opt/miniconda3/bin/conda config --add channels https://repo.anaconda.com/pkgs/msys2 && \
    /opt/miniconda3/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    /opt/miniconda3/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r && \
    /opt/miniconda3/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/msys2 && \
    /opt/miniconda3/bin/conda config --add channels conda-forge && \
    /opt/miniconda3/bin/conda config --set show_channel_urls yes && \
    /opt/miniconda3/bin/conda clean -afy

# 复制pip配置文件
COPY pip.conf /opt/biomni/

# 配置pip以支持更长的超时和重试
RUN mkdir -p /opt/miniconda3/pip && \
    cp /opt/biomni/pip.conf /opt/miniconda3/pip/pip.conf && \
    mkdir -p /home/biomni/.pip && \
    cp /opt/biomni/pip.conf /home/biomni/.pip/pip.conf && \
    echo 'export PIP_CONFIG_FILE=/opt/miniconda3/pip/pip.conf' >> /opt/miniconda3/etc/profile.d/conda.sh

# 复制原始 environment.yml
COPY environment.yml ./

# 安装pyyaml用于解析yml
RUN pip3 install pyyaml

# 自动生成 requirements.txt 和 environment.conda.yml
RUN cat <<EOF > split_env.py
import yaml
f = open('environment.yml')
d = yaml.safe_load(f)
f.close()
pip_list = []
new_deps = []
for dep in d['dependencies']:
    if isinstance(dep, dict) and 'pip' in dep:
        pip_list.extend(dep['pip'])
    else:
        new_deps.append(dep)
d['dependencies'] = new_deps
open('requirements.txt', 'w').write('\n'.join(pip_list))
open('environment.conda.yml', 'w').write(yaml.dump(d, sort_keys=False))
EOF
RUN python3 split_env.py && rm split_env.py

# 创建conda环境（只装conda包）
RUN /opt/miniconda3/bin/conda env create -n biomni_e1 -f environment.conda.yml && \
    /opt/miniconda3/bin/conda clean -afy

# 手动pip安装，显示详细日志 - 直接使用环境中的pip
RUN /opt/miniconda3/envs/biomni_e1/bin/pip install --upgrade pip setuptools wheel && \
    /opt/miniconda3/envs/biomni_e1/bin/pip install \
    # 基础科学计算
    numpy==2.1 pandas matplotlib scipy statsmodels scikit-learn \
    # AI/ML相关
    gradio langchain langgraph==0.3.18 langchain_openai langchain_anthropic \
    langchain_community langchain-google-genai langchain_ollama openai \
    # 数据处理
    beautifulsoup4 lxml tqdm seaborn networkx requests pyyaml \
    # Jupyter环境
    jupyter notebook ipykernel pytest && \
    /opt/miniconda3/envs/biomni_e1/bin/pip install langchain_aws biopython

# 增量安装requirements.txt - 直接使用环境中的pip
RUN /opt/miniconda3/envs/biomni_e1/bin/pip install -r requirements.txt

# 创建biomni用户
RUN useradd -u 1005 -m -s /bin/bash biomni && \
    chown -R biomni:biomni /opt/biomni /opt/miniconda3

# 设置环境变量
ENV PATH="/opt/miniconda3/envs/biomni_e1/bin:$PATH"
ENV CONDA_DEFAULT_ENV="biomni_e1"

# 切换到biomni用户
USER biomni

# 暴露Jupyter和Gradio端口
EXPOSE 8888 7860

# 默认命令
CMD ["/bin/bash"] 