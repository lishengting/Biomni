# Biomni Environment Dockerfile - 优化版
# 基于biomni-basic.1镜像，避免重复构建基础环境

FROM biomni_env-biomni-basic.1

# 设置环境变量
ENV PATH="/opt/biomni_tools/bin:$PATH"
ENV HOMER="/opt/biomni_tools/homer"
ENV PIP_CONFIG_FILE="/opt/miniconda3/pip/pip.conf"

# 切换到root用户进行系统级安装
USER root

# 安装额外的系统依赖（生物信息学工具）
RUN apt-get update && apt-get install -y --no-install-recommends \
    # 额外的科学计算依赖
    libcairo2-dev libpango1.0-dev \
    libhdf5-dev libnetcdf-dev \
    # R环境
    r-base r-base-dev \
    # 生物信息学命令行工具
    samtools bcftools bedtools fastqc bowtie2 bwa \
    ncbi-tools-bin ncbi-blast+ mafft trimmomatic \
    # 清理缓存
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# 创建工具目录
RUN mkdir -p /opt/biomni_tools/bin && \
    chown -R biomni:biomni /opt/biomni_tools

# 复制额外的配置文件
COPY --chown=biomni:biomni bio_env.yml r_packages.yml ./
COPY --chown=biomni:biomni install_cli_tools.sh cli_tools_config.json ./
COPY --chown=biomni:biomni install_r_packages.R ./
COPY --chown=biomni:biomni setup.sh ./

# 切换到biomni用户
USER biomni

# 配置R使用国内镜像
RUN echo "options(repos = c(CRAN = 'https://mirrors.ustc.edu.cn/CRAN/'))" > ~/.Rprofile && \
    echo "options(BioC_mirror = 'https://mirrors.ustc.edu.cn/bioconductor')" >> ~/.Rprofile

# 更新conda环境，添加额外的依赖
RUN /opt/miniconda3/bin/conda env update -n biomni_e1 -f bio_env.yml
RUN /opt/miniconda3/bin/conda env update -n biomni_e1 -f r_packages.yml && \
    /opt/miniconda3/bin/conda clean -afy

# 安装额外的R包
RUN /opt/miniconda3/envs/biomni_e1/bin/Rscript install_r_packages.R || echo "Some R packages may have failed, continuing..."

# 安装CLI工具
RUN /opt/miniconda3/envs/biomni_e1/bin/bash install_cli_tools.sh || echo "Some CLI tools may have failed, continuing..."

# 暴露端口
EXPOSE 8888 7860

# 默认命令
CMD ["/bin/bash"] 