# Biomni Environment Dockerfile - ä¼˜åŒ–ç‰ˆ
# åŸºäºbiomni-basic.1é•œåƒï¼Œé¿å…é‡å¤æ„å»ºåŸºç¡€ç¯å¢ƒ

FROM biomni_env-biomni-basic.1

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PATH="/opt/biomni_tools/bin:$PATH"
ENV HOMER="/opt/biomni_tools/homer"
ENV PIP_CONFIG_FILE="/opt/miniconda3/pip/pip.conf"

# åˆ‡æ¢åˆ°rootç”¨æˆ·è¿›è¡Œç³»ç»Ÿçº§å®‰è£…
USER root

# å®‰è£…é¢å¤–çš„ç³»ç»Ÿä¾èµ–ï¼ˆç”Ÿç‰©ä¿¡æ¯å­¦å·¥å…·ï¼‰
RUN apt-get update && apt-get install -y --no-install-recommends \
    # é¢å¤–çš„ç§‘å­¦è®¡ç®—ä¾èµ–
    libcairo2-dev libpango1.0-dev \
    libhdf5-dev libnetcdf-dev \
    # Rç¯å¢ƒ
    r-base r-base-dev \
    # ç”Ÿç‰©ä¿¡æ¯å­¦å‘½ä»¤è¡Œå·¥å…·
    samtools bcftools bedtools fastqc bowtie2 bwa \
    ncbi-tools-bin ncbi-blast+ mafft trimmomatic \
    # æ¸…ç†ç¼“å­˜
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# åˆ›å»ºå·¥å…·ç›®å½•
RUN mkdir -p /opt/biomni_tools/bin && \
    chown -R biomni:biomni /opt/biomni_tools

# å¤åˆ¶é¢å¤–çš„é…ç½®æ–‡ä»¶
COPY --chown=biomni:biomni bio_env.yml r_packages.yml ./

# åˆ‡æ¢åˆ°biomniç”¨æˆ·
USER biomni

# æ‹†åˆ† bio_env.yml
RUN cat <<EOF > split_bio_env.py
import yaml
import math

with open('bio_env.yml') as f:
    d = yaml.safe_load(f)

conda_deps = []
pip_deps = []
for dep in d['dependencies']:
    if isinstance(dep, dict) and 'pip' in dep:
        pip_deps.extend(dep['pip'])
    else:
        conda_deps.append(dep)

# å†™å…¥ conda-only yml
d['dependencies'] = conda_deps
with open('bio_env.conda.yml', 'w') as f:
    yaml.dump(d, f, sort_keys=False)

# æ‹†åˆ† pip requirements
chunk_size = 10
for i in range(math.ceil(len(pip_deps)/chunk_size)):
    chunk = pip_deps[i*chunk_size:(i+1)*chunk_size]
    fname = f'requirements.{i+1:02d}.txt'
    with open(fname, 'w') as f:
        f.write('\n'.join(chunk))
EOF
RUN python3 split_bio_env.py && rm split_bio_env.py

# ç”¨ conda å®‰è£… conda-only ä¾èµ–
RUN /opt/miniconda3/bin/conda env update -n biomni_e1 -f bio_env.conda.yml && \
    /opt/miniconda3/bin/conda env update -n biomni_e1 -f r_packages.yml 

# åˆ†æ‰¹å®‰è£… pip requirements
RUN for f in requirements.*.txt; do \
      echo "==== å®‰è£… $f ===="; \
      cat $f; echo ""; \
      pip install -r $f; \
    done

ENV MAKEFLAGS="-j16"
RUN echo $FORCE_R_REBUILD
# å®‰è£…é¢å¤–çš„RåŒ…
# é…ç½®Rä½¿ç”¨å›½å†…é•œåƒ
RUN echo "options(repos = c(CRAN = 'https://mirrors.ustc.edu.cn/CRAN/'))" > ~/.Rprofile && \
    echo "options(BioC_mirror = 'https://mirrors.ustc.edu.cn/bioconductor')" >> ~/.Rprofile

COPY --chown=biomni:biomni install_r_packages.R ./
RUN /opt/miniconda3/envs/biomni_e1/bin/Rscript install_r_packages.R 2>&1 | tee install_r_packages.log || echo "Some R packages may have failed, continuing... (see install_r_packages.log)"

COPY --chown=biomni:biomni install_cli_tools.sh cli_tools_config.json ./
# å®‰è£…CLIå·¥å…·
RUN /bin/bash install_cli_tools.sh --auto 2>&1 | tee install_cli_tools.log || echo "Some CLI tools may have failed, continuing... (see install_cli_tools.log)"

# è‡ªåŠ¨æ¿€æ´»condaç¯å¢ƒ
COPY --chown=biomni:biomni setup.sh ./
RUN echo 'source /opt/miniconda3/etc/profile.d/conda.sh' >> /home/biomni/.bashrc && \
    echo 'conda activate biomni_e1' >> /home/biomni/.bashrc && \
    echo 'echo "ğŸŸ¢ Condaç¯å¢ƒå·²æ¿€æ´»: $(conda info --envs | grep "*" | awk "{print \$1}")"' >> /home/biomni/.bashrc

# æš´éœ²ç«¯å£
EXPOSE 8888 7860

# é»˜è®¤å‘½ä»¤
CMD ["/bin/bash"] 