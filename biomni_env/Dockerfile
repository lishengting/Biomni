# Biomni Environment Dockerfile
# åŸºäºUbuntu 22.04æ„å»ºå®Œæ•´çš„ç”Ÿç‰©ä¿¡æ¯å­¦ç¯å¢ƒ

FROM ubuntu:22.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PATH="/opt/biomni_tools/bin:$PATH"
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /opt/biomni

# å®‰è£…åŸºç¡€å·¥å…·å’Œç¼–è¯‘ç¯å¢ƒ
RUN apt-get update && apt-get install -y \
    # åŸºç¡€å·¥å…·
    wget curl git vim nano htop \
    # ç¼–è¯‘å·¥å…·
    build-essential gcc g++ make cmake \
    # å…¶ä»–åŸºç¡€ä¾èµ–
    jq unzip zip bzip2 gzip \
    # æ¸…ç†ç¼“å­˜
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Python 3.11ï¼ˆéœ€è¦æ·»åŠ PPAï¼‰
RUN apt-get update && apt-get install -y \
    software-properties-common && \
    add-apt-repository ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y python3.11 python3.11-dev python3.11-venv python3.11-distutils && \
    # åˆ›å»ºPython 3.11çš„ç¬¦å·é“¾æ¥
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1 && \
    # å®‰è£…pipï¼ˆPPAä¸­æ²¡æœ‰python3.11-pipåŒ…ï¼Œéœ€è¦ä½¿ç”¨get-pip.pyï¼‰
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11 && \
    # æ¸…ç†ç¼“å­˜
    apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Rç¯å¢ƒï¼ˆR 4.4+ï¼‰
RUN apt-get update && apt-get install -y \
    software-properties-common dirmngr apt-transport-https ca-certificates gnupg && \
    # æ·»åŠ CRANå®˜æ–¹å¯†é’¥å’Œæº
    wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | gpg --dearmor -o /usr/share/keyrings/r-project.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/r-project.gpg] https://cloud.r-project.org/bin/linux/ubuntu jammy-cran40/" | tee -a /etc/apt/sources.list.d/r-project.list && \
    apt-get update && \
    apt-get install -y r-base r-base-dev && \
    # æ¸…ç†ç¼“å­˜
    apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…ç”Ÿç‰©ä¿¡æ¯å­¦ä¾èµ–åº“
RUN apt-get update && apt-get install -y \
    # å‹ç¼©åº“
    libz-dev libbz2-dev liblzma-dev \
    # ç½‘ç»œå’ŒåŠ å¯†åº“
    libcurl4-openssl-dev libssl-dev \
    # XMLå’Œå›¾åƒåº“
    libxml2-dev libpng-dev libjpeg-dev \
    libfreetype6-dev libtiff5-dev \
    # å›¾å½¢åº“
    libcairo2-dev libpango1.0-dev \
    # æ•°å­¦åº“
    libblas-dev liblapack-dev libgsl-dev \
    # ç§‘å­¦è®¡ç®—åº“
    libhdf5-dev libnetcdf-dev \
    # åºåˆ—åˆ†æå·¥å…·
    samtools bcftools bedtools fastqc bowtie2 bwa \
    # NCBIå·¥å…·
    ncbi-tools-bin ncbi-blast+ \
    # åºåˆ—æ¯”å¯¹å·¥å…·  
    mafft \
    # è´¨é‡æ§åˆ¶å·¥å…·
    trimmomatic \
    # æ¸…ç†ç¼“å­˜
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºbiomniç”¨æˆ·
RUN useradd -u 1005 -m -s /bin/bash biomni && \
    chown -R biomni:biomni /opt/biomni && \
    # åˆ›å»ºå·¥å…·ç›®å½•å¹¶è®¾ç½®æƒé™ï¼ˆåœ¨åˆ‡æ¢åˆ°biomniç”¨æˆ·ä¹‹å‰ï¼‰
    mkdir -p /opt/biomni_tools/bin && \
    chown -R biomni:biomni /opt/biomni_tools

# åˆ‡æ¢åˆ°biomniç”¨æˆ·
USER biomni

# åˆ›å»ºPython 3.11è™šæ‹Ÿç¯å¢ƒ
RUN python3.11 -m venv /opt/biomni/venv
ENV PATH="/opt/biomni/venv/bin:$PATH"

# å¤åˆ¶pipé…ç½®æ–‡ä»¶
COPY --chown=biomni:biomni pip.conf /opt/biomni/

# é…ç½®pipä»¥æ”¯æŒæ›´é•¿çš„è¶…æ—¶å’Œé‡è¯•
RUN . /opt/biomni/venv/bin/activate && \
    mkdir -p /opt/biomni/venv/pip && \
    cp /opt/biomni/pip.conf /opt/biomni/venv/pip/pip.conf && \
    # åŒæ—¶å¤åˆ¶åˆ°ç”¨æˆ·ç›®å½•ç¡®ä¿pipèƒ½æ‰¾åˆ°é…ç½®
    mkdir -p /home/biomni/.pip && \
    cp /opt/biomni/pip.conf /home/biomni/.pip/pip.conf && \
    # è®¾ç½®ç¯å¢ƒå˜é‡æŒ‡å‘pipé…ç½®
    echo 'export PIP_CONFIG_FILE=/opt/biomni/venv/pip/pip.conf' >> /opt/biomni/venv/bin/activate && \
    # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶å‡çº§pipï¼ˆä½¿ç”¨é…ç½®åçš„pipï¼‰
    python --version && \
    pip config list && \
    pip install --upgrade pip setuptools wheel

# å¤åˆ¶ç¯å¢ƒæ–‡ä»¶
COPY --chown=biomni:biomni environment.yml /opt/biomni/
COPY --chown=biomni:biomni bio_env.yml /opt/biomni/
COPY --chown=biomni:biomni r_packages.yml /opt/biomni/

# å¤§åŒ…ï¼Œå•ç‹¬å®‰è£…
RUN . /opt/biomni/venv/bin/activate && \
    pip install scvi-tools

# åˆå¹¶æ‰€æœ‰PythonåŒ…å®‰è£…ä¸ºä¸€ä¸ªRUNå‘½ä»¤ï¼Œæå‡æ„å»ºæ•ˆç‡ï¼ˆåŸåˆ†æ•£RUNå‘½ä»¤å·²æ³¨é‡Šï¼Œè§ä¸‹æ–¹ï¼‰
RUN . /opt/biomni/venv/bin/activate && \
    pip install \
        tqdm numpy==2.1 pandas matplotlib scipy statsmodels scikit-learn \
        gradio langchain langgraph==0.3.18 langchain_openai langchain_anthropic \
        langchain_community langchain-google-genai langchain_ollama openai \
        biopython scanpy scvelo biopandas \
        biotite opencv-python rdkit macs2 pymc3 cryosparc-tools lifelines \
        scikit-image googlesearch-python PyPDF2 gget faiss-cpu \
        cellxgene-census scikit-bio pymed arxiv scholarly umap-learn \
        scrublet harmony-pytorch pyliftover pytdc==0.4.0 pysam pyfaidx \
        pyranges pybedtools openmm pystan igraph pyscenic cooler \
        trackpy flowcytometrytools cellpose viennarna PyMassSpec \
        python-libsbml cobra reportlab hmmlearn msprime tskit \
        cyvcf2 pykalman community fanc \
        gseapy beautifulsoup4 lxml seaborn networkx requests pyyaml jupyter notebook ipykernel pytest

# ä»¥ä¸‹ä¸ºåŸåˆ†æ•£å®‰è£…å‘½ä»¤ï¼Œå·²åˆå¹¶ï¼Œæ³¨é‡Šæ‰ä»¥ä¾¿è¿½æº¯ï¼ˆåˆå¹¶åŸå› ï¼šå‡å°‘é•œåƒå±‚æ•°ã€åŠ é€Ÿæ„å»ºï¼‰
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install scvi-tools
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install tqdm numpy==2.1 pandas matplotlib scipy statsmodels scikit-learn 
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install gradio langchain langgraph==0.3.18 langchain_openai langchain_anthropic \
#                 langchain_community langchain-google-genai langchain_ollama openai
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install biopython scanpy scvelo biopandas
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install biotite opencv-python rdkit macs2 pymc3 cryosparc-tools lifelines
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install scikit-image googlesearch-python PyPDF2 gget faiss-cpu
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install cellxgene-census scikit-bio pymed arxiv scholarly umap-learn
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install scrublet harmony-pytorch pyliftover pytdc==0.4.0 pysam pyfaidx
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install pyranges pybedtools openmm pystan igraph pyscenic cooler
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install trackpy flowcytometrytools cellpose viennarna PyMassSpec
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install python-libsbml cobra reportlab hmmlearn msprime tskit
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install cyvcf2 pykalman community fanc
# RUN . /opt/biomni/venv/bin/activate && \
#     pip install gseapy beautifulsoup4 lxml seaborn networkx requests pyyaml jupyter notebook ipykernel pytest

# å¼€å‘æ¨¡å¼å®‰è£…biomniæºç 
# RUN /opt/biomni/venv/bin/pip install -e /opt/biomni

# å·¥å…·ç›®å½•å·²åœ¨å‰é¢åˆ›å»ºå¹¶è®¾ç½®æƒé™

USER root

ENV MAKEFLAGS="-j16"
# å®‰è£…æ‰€æœ‰RåŒ…ï¼ˆåˆå¹¶å¤šä¸ªRUNå‘½ä»¤ï¼‰
RUN Rscript -e "install.packages(c('ggplot2', 'dplyr', 'tidyr', 'readr', 'stringr', 'lme4'), repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "install.packages('Matrix', repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "install.packages('Rcpp', repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "install.packages(c('devtools', 'remotes'), repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "install.packages('harmony', repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "if (!require('BiocManager', quietly = TRUE)) install.packages('BiocManager', repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "BiocManager::install(version = BiocManager::version(), update = TRUE, ask = FALSE)" && \
    Rscript -e "options(BioC_mirror='https://mirrors.westlake.edu.cn/bioconductor', repos='https://mirrors.ustc.edu.cn/CRAN/'); BiocManager::install('DESeq2', update = FALSE, ask = FALSE)" && \
    Rscript -e "options(BioC_mirror='https://mirrors.westlake.edu.cn/bioconductor', repos='https://mirrors.ustc.edu.cn/CRAN/'); BiocManager::install('DADA2', update = FALSE, ask = FALSE)" && \
    Rscript -e "options(BioC_mirror='https://mirrors.westlake.edu.cn/bioconductor', repos='https://mirrors.ustc.edu.cn/CRAN/'); BiocManager::install('xcms', update = FALSE, ask = FALSE)" && \
    Rscript -e "options(BioC_mirror='https://mirrors.westlake.edu.cn/bioconductor', repos='https://mirrors.ustc.edu.cn/CRAN/'); BiocManager::install('FlowCore', update = FALSE, ask = FALSE)" && \
    Rscript -e "options(BioC_mirror='https://mirrors.westlake.edu.cn/bioconductor', repos='https://mirrors.ustc.edu.cn/CRAN/'); BiocManager::install('edgeR', update = FALSE, ask = FALSE)" && \
    Rscript -e "options(BioC_mirror='https://mirrors.westlake.edu.cn/bioconductor', repos='https://mirrors.ustc.edu.cn/CRAN/'); BiocManager::install('limma', update = FALSE, ask = FALSE)" && \
    Rscript -e "options(BioC_mirror='https://mirrors.westlake.edu.cn/bioconductor', repos='https://mirrors.ustc.edu.cn/CRAN/'); BiocManager::install('clusterProfiler', update = FALSE, ask = FALSE)" && \
    Rscript -e "install.packages('WGCNA', repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "install.packages(c('dynamicTreeCut', 'fastcluster', 'matrixStats', 'Hmisc', 'foreach', 'doParallel'), repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "options(BioC_mirror='https://mirrors.westlake.edu.cn/bioconductor', repos='https://mirrors.ustc.edu.cn/CRAN/'); BiocManager::install(c('impute', 'preprocessCore', 'GO.db', 'AnnotationDbi'), update = FALSE, ask = FALSE)"

RUN Rscript -e "if (!require('devtools', quietly = TRUE)) install.packages('devtools', repos='https://mirrors.ustc.edu.cn/CRAN/')" && \
    Rscript -e "devtools::install_github('liulab-dfci/MAGeCKFlute')"

# åˆ‡æ¢å›biomniç”¨æˆ·
USER biomni

# å¤åˆ¶CLIå·¥å…·å®‰è£…è„šæœ¬
COPY --chown=biomni:biomni install_cli_tools.sh /opt/biomni/
COPY --chown=biomni:biomni cli_tools_config.json /opt/biomni/
COPY --chown=biomni:biomni install_r_packages.R /opt/biomni/

# å¤åˆ¶é¢„ä¸‹è½½çš„å·¥å…·æ–‡ä»¶
COPY --chown=biomni:biomni downloads/ /opt/biomni/downloads/

# å®‰è£…å‘½ä»¤è¡Œå·¥å…·ï¼ˆä½¿ç”¨é¢„ä¸‹è½½çš„æ–‡ä»¶ï¼‰
RUN cd /opt/biomni && \
    chmod +x install_cli_tools.sh && \
    # è®¾ç½®ç¯å¢ƒå˜é‡
    export BIOMNI_TOOLS_DIR="/opt/biomni_tools" && \
    export BIOMNI_AUTO_INSTALL=1 && \
    # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
    mkdir -p /opt/biomni/tmp_build && \
    # å®‰è£…PLINK2
    unzip /opt/biomni/downloads/plink2_linux_avx2_20250129.zip -d /opt/biomni/tmp_build/ && \
    cp /opt/biomni/tmp_build/plink2 /opt/biomni_tools/bin/ && \
    chmod +x /opt/biomni_tools/bin/plink2 && \
    # å®‰è£…IQ-TREE
    tar -xzf /opt/biomni/downloads/iqtree-2.2.2.7-Linux.tar.gz -C /opt/biomni/tmp_build/ && \
    cp /opt/biomni/tmp_build/iqtree-2.2.2.7-Linux/bin/iqtree2 /opt/biomni_tools/bin/ && \
    chmod +x /opt/biomni_tools/bin/iqtree2 && \
    # å®‰è£…GCTA
    unzip /opt/biomni/downloads/gcta-1.94.4-linux-kernel-3-x86_64.zip -d /opt/biomni/tmp_build/ && \
    cp /opt/biomni/tmp_build/gcta-1.94.4-linux-kernel-3-x86_64/gcta64 /opt/biomni_tools/bin/ && \
    chmod +x /opt/biomni_tools/bin/gcta64 && \
    # å®‰è£…FastTree
    gcc -O3 -finline-functions -funroll-loops -Wall -o /opt/biomni_tools/bin/FastTree /opt/biomni/downloads/FastTree.c -lm && \
    chmod +x /opt/biomni_tools/bin/FastTree && \
    # å®‰è£…MUSCLE
    cp /opt/biomni/downloads/muscle-linux-x86.v5.3 /opt/biomni_tools/bin/muscle && \
    chmod +x /opt/biomni_tools/bin/muscle && \
    # å®‰è£…HOMER
    mkdir -p /opt/biomni_tools/homer && \
    cp /opt/biomni/downloads/configureHomer.pl /opt/biomni_tools/homer/ && \
    chmod +x /opt/biomni_tools/homer/configureHomer.pl && \
    cd /opt/biomni_tools/homer && \
    ./configureHomer.pl -install && \
    # æ£€æŸ¥HOMERå®‰è£…æ˜¯å¦æˆåŠŸ
    if [ ! -d "/opt/biomni_tools/homer/bin" ] || [ -z "$(ls -A /opt/biomni_tools/homer/bin 2>/dev/null)" ]; then \
        echo "ERROR: HOMER installation failed! /opt/biomni_tools/homer/bin/ directory does not exist or is empty." && \
        echo "Please check the HOMER installation process." && \
        exit 1; \
    fi && \
    echo "HOMER installation successful. Found $(ls /opt/biomni_tools/homer/bin/ | wc -l) tools in bin directory." && \
    # åˆ›å»ºHOMERçš„ç¬¦å·é“¾æ¥åˆ°binç›®å½•
    ln -sf /opt/biomni_tools/homer/bin/* /opt/biomni_tools/bin/ && \
    # å®‰è£…BWAï¼ˆä»GitHubå…‹éš†æºç ç¼–è¯‘ï¼‰
    git clone https://github.com/lh3/bwa.git /opt/biomni/tmp_build/bwa && \
    cd /opt/biomni/tmp_build/bwa && \
    make && \
    cp bwa /opt/biomni_tools/bin/ && \
    chmod +x /opt/biomni_tools/bin/bwa && \
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf /opt/biomni/tmp_build

# å®‰è£…RåŒ…ï¼ˆåˆ‡æ¢åˆ°rootç”¨æˆ·å®‰è£…ï¼Œç„¶ååˆ‡æ¢å›biomniç”¨æˆ·ï¼‰

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PATH="/opt/biomni/venv/bin:$PATH"
ENV HOMER="/opt/biomni_tools/homer"

# åˆ›å»ºè‡ªåŠ¨æ¿€æ´»è™šæ‹Ÿç¯å¢ƒçš„bashé…ç½®æ–‡ä»¶
RUN echo 'source /opt/biomni/venv/bin/activate' >> /home/biomni/.bashrc && \
    echo 'echo "ğŸ Python virtual environment activated: $(python --version)"' >> /home/biomni/.bashrc && \
    echo 'echo "ğŸ“ Working directory: $(pwd)"' >> /home/biomni/.bashrc && \
    echo 'echo "ğŸ”§ Available tools: biomni_tools/bin is in PATH"' >> /home/biomni/.bashrc

# æš´éœ²Jupyterå’ŒGradioç«¯å£
EXPOSE 8888 7860

# æ³¨é‡Šæ‰ENTRYPOINTï¼Œè®©docker-compose.ymlçš„commandå®Œå…¨æ§åˆ¶
# ENTRYPOINT ["/bin/bash", "/opt/biomni/scripts/start.sh"]

# é»˜è®¤å‘½ä»¤
CMD ["/bin/bash"] 